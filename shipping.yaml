# âœ… Summary:
#        What You Want	                                 Command / Action
#  Check Maven version (RHEL/CentOS)	       dnf info maven or dnf list maven --showduplicates
#  Check Maven version (Ubuntu)	             apt-cache policy maven
#  Google Search	                           maven available version in dnf/yum/apt
#  Official Site                          	 https://maven.apache.org/download.cgi

- name: configure the shipping microservices/component in Backend
  hosts: shipping
  become: yes
  tasks:
  - name: Installing maven and mysql
    ansible.builtin.package:
      name: "{{ item }}"
      state: present 
    loop:
    - maven
    - mysql 

# Shipping service is responsible for finding the distance of the package to be shipped and calculate the price based on that.
# Shipping service is written in Java, Hence we need to install Java.
# Maven is a Java Packaging software, Hence we are going to install maven, This indeed takes care of java installation.
# Developer has chosen Maven, Check with developer which version of Maven is needed. Here for our requirement java >= 1.8 & maven >=3.5 should work.
  
  
  - name: install PyMySQL and cryptography 
    ansible.builtin.pip:     # .pip <---- because these are dependencies, not packages 
      name: "{{ item }}"     # ansible build by python 
      executable: pip3.9
    loop:
    - cryptography
    - PyMySQL


  - name: creating a directory
    ansible.builtin.file:
      path: /app
      state: directory 

  - name: Applications should run as nonroot user, so we are creating roboshop system user
    ansible.builtin.user:
      name: roboshop
      home: /app
      shell: /sbin/nologin
      system: true

# âœ… What is system:?

    # This marks the user as a system-level user, not a normal human user.
    # System users are created for running services or background processes.

# âŒ Why we donâ€™t use path: here:

    # ðŸ”º path: is not a valid option in the user module.
    # path: is used in (file) or (copy) modules
    # But in the user module, thereâ€™s no such field as path.

# ðŸ—£ï¸ In Telugu:

    # home: ane field lo manam ee user ki base folder ekkada undalo cheptam. Example: (files) or (logs) store cheyataniki.

  # - name: creating a directory
  #   ansible.builtin.file:
  #     path: /app
  #     state: directory 

  - name: downloading the shipping application code in to app directory
    ansible.builtin.get_url:
      url: https://roboshop-artifacts.s3.amazonaws.com/shipping-v3.zip 
      dest: /tmp/shipping.zip 

  - name: unarchive/Extract the downloaded file
    ansible.builtin.unarchive:
      src: /tmp/shipping.zip 
      dest: /app
      remote_src: yes

  - name: To run the code we need librarices and dependencies, that's why we are installing maven
    ansible.builtin.command: mvn clean package
    args:
      chdir: /app

  - name: After Installation we are rename jar file
    ansible.builtin.command: mv target/shipping-1.0.jar shipping.jar
    args:
      chdir: /app

  - name: we need dot service file, due to our custmized application
    ansible.builtin.copy:
      src: shipping.service
      dest: /etc/systemd/system/shipping.service

  
  - name: if you change any systemd file, you need to daemon-reload
    ansible.builtin.systemd_service:
      daemon_reload: true

  - name: enable shipping
    ansible.builtin.service:
      name: shipping
      enabled: yes

  - name: Start shipping
    ansible.builtin.service:
      name: shipping
      state: started

  # - name: Installing mysql
  #   ansible.builtin.package:
  #     name: mysql
  #     state: present

  # - name: connect to mysql using app user
  #   community.mysql.mysql_info:
  #     login_user: shipping
  #     login_password: RoboShop@1
  #     login_host: mysql.daws84s.site
  #     login_db: cities

# import data ante load cheyapote load chestumdhi, oka vela load chesi unte inak load cheyadu

  - name: import data 
    tags: 
      - import
    community.mysql.mysql_db:
      name: all 
      login_user: roboshop 
      login_password: Roboshop@1
      login_host: mysql.kalyanu.xyz
      state: import
      target: "{{ item }}"  # target manaki chala unne load cheyataniki, andhuke manam loop chestunnam
    loop:
    - /app/db/schema.sql
    - /app/db/app-user.sql 
    - /app/db/master-data.sql

  - name: restart shipping
    tags:
    - import
    ansible.builtin.service:
      state: restared
      name: shipping



